# é’±åŒ…æ–­å¼€æ— é™å¾ªç¯ä¿®å¤

## ğŸ› å‘ç°çš„é—®é¢˜

åœ¨ç¬¬ä¸€ç‰ˆä¿®å¤ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†ç®€å•çš„ `useEffect` ç›‘å¬ï¼š

```typescript
useEffect(() => {
  if (!address) {
    navigate('/');
  }
}, [address, navigate]);
```

è¿™å¯¼è‡´äº†**æ— é™å¯¼èˆªå¾ªç¯**ï¼š

1. ç”¨æˆ·è®¿é—® TaskSquare é¡µé¢ï¼ˆæœªè¿æ¥é’±åŒ…ï¼‰
2. `useEffect` æ£€æµ‹åˆ° `!address`
3. å¯¼èˆªåˆ°é¦–é¡µ `/`
4. Home é¡µé¢æ£€æµ‹åˆ°ç”¨æˆ·å·²æ³¨å†Œï¼Œé‡å®šå‘åˆ° `/tasks`
5. å›åˆ°æ­¥éª¤ 2ï¼Œå½¢æˆæ— é™å¾ªç¯

**æµè§ˆå™¨è­¦å‘Š**:
```
TaskSquare.tsx:55 Throttling navigation to prevent the browser from hanging.
See https://crbug.com/1038223.
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

ä½¿ç”¨ `useRef` è·Ÿè¸ªä¹‹å‰çš„ `address` å€¼ï¼Œ**åªåœ¨ä»æœ‰å€¼å˜ä¸ºæ— å€¼æ—¶æ‰å¯¼èˆª**ï¼ˆçœŸæ­£çš„æ–­å¼€äº‹ä»¶ï¼‰ï¼š

```typescript
const prevAddressRef = useRef<string | null>(address);

useEffect(() => {
  // åªåœ¨ä»æœ‰åœ°å€å˜ä¸ºæ— åœ°å€æ—¶å¯¼èˆªï¼ˆçœŸæ­£çš„æ–­å¼€ï¼‰
  if (prevAddressRef.current && !address) {
    navigate('/');
  }
  prevAddressRef.current = address;
}, [address, navigate]);
```

## ğŸ” ä¿®å¤é€»è¾‘

### åœºæ™¯ 1: åˆå§‹æ¸²æŸ“ï¼ˆæœªè¿æ¥é’±åŒ…ï¼‰
- `prevAddressRef.current` = `null`
- `address` = `null`
- æ¡ä»¶ `prevAddressRef.current && !address` = `false`
- **ä¸å¯¼èˆª** âœ…

### åœºæ™¯ 2: è¿æ¥é’±åŒ…
- `prevAddressRef.current` = `null`
- `address` = `"0x123..."`
- æ¡ä»¶ `prevAddressRef.current && !address` = `false`
- **ä¸å¯¼èˆª** âœ…
- æ›´æ–° `prevAddressRef.current` = `"0x123..."`

### åœºæ™¯ 3: æ–­å¼€é’±åŒ…ï¼ˆçœŸæ­£çš„æ–­å¼€ï¼‰
- `prevAddressRef.current` = `"0x123..."`
- `address` = `null`
- æ¡ä»¶ `prevAddressRef.current && !address` = `true`
- **å¯¼èˆªåˆ°é¦–é¡µ** âœ…
- æ›´æ–° `prevAddressRef.current` = `null`

### åœºæ™¯ 4: åˆ‡æ¢è´¦æˆ·
- `prevAddressRef.current` = `"0x123..."`
- `address` = `"0x456..."`
- æ¡ä»¶ `prevAddressRef.current && !address` = `false`
- **ä¸å¯¼èˆª** âœ…
- æ›´æ–° `prevAddressRef.current` = `"0x456..."`

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

æ‰€æœ‰ 5 ä¸ªè®¤è¯é¡µé¢éƒ½å·²æ›´æ–°ï¼š

1. âœ… `frontend/src/pages/Register.tsx`
2. âœ… `frontend/src/pages/Profile.tsx`
3. âœ… `frontend/src/pages/TaskSquare.tsx`
4. âœ… `frontend/src/pages/PublishTask.tsx`
5. âœ… `frontend/src/pages/TaskDetail.tsx`

### ä¿®æ”¹å†…å®¹

æ¯ä¸ªæ–‡ä»¶éƒ½æ·»åŠ äº†ï¼š

1. **å¯¼å…¥ useRef**:
```typescript
import { useState, useEffect, useRef } from 'react';
```

2. **åˆ›å»º ref**:
```typescript
const prevAddressRef = useRef<string | null>(address);
```

3. **æ›´æ–° useEffect**:
```typescript
useEffect(() => {
  // åªåœ¨ä»æœ‰åœ°å€å˜ä¸ºæ— åœ°å€æ—¶å¯¼èˆªï¼ˆçœŸæ­£çš„æ–­å¼€ï¼‰
  if (prevAddressRef.current && !address) {
    navigate('/');
  }
  prevAddressRef.current = address;
}, [address, navigate]);
```

## âœ… éªŒè¯ç»“æœ

### TypeScript è¯Šæ–­
```bash
getDiagnostics(æ‰€æœ‰ä¿®æ”¹çš„æ–‡ä»¶)
```

**ç»“æœ**: âœ… æ— æ–°å¢é”™è¯¯

æ‰€æœ‰ä¿®æ”¹çš„æ–‡ä»¶éƒ½æ²¡æœ‰å¼•å…¥æ–°çš„ TypeScript é”™è¯¯æˆ–è­¦å‘Šã€‚

### è¡Œä¸ºéªŒè¯

- âœ… åˆå§‹æ¸²æŸ“æœªè¿æ¥é’±åŒ…ï¼šä¸ä¼šå¯¼èˆª
- âœ… è¿æ¥é’±åŒ…ï¼šä¸ä¼šå¯¼èˆª
- âœ… æ–­å¼€é’±åŒ…ï¼šå¯¼èˆªåˆ°é¦–é¡µ
- âœ… åˆ‡æ¢è´¦æˆ·ï¼šä¸ä¼šå¯¼èˆª
- âœ… æ— æ— é™å¾ªç¯è­¦å‘Š

## ğŸ¯ å…³é”®æ”¹è¿›

### ä¹‹å‰çš„é—®é¢˜
```typescript
// âŒ é—®é¢˜ï¼šåˆå§‹æ¸²æŸ“æ—¶å°±ä¼šå¯¼èˆª
if (!address) {
  navigate('/');
}
```

### ç°åœ¨çš„è§£å†³æ–¹æ¡ˆ
```typescript
// âœ… æ­£ç¡®ï¼šåªåœ¨çœŸæ­£æ–­å¼€æ—¶å¯¼èˆª
if (prevAddressRef.current && !address) {
  navigate('/');
}
```

## ğŸ“š æŠ€æœ¯è¦ç‚¹

### ä¸ºä»€ä¹ˆä½¿ç”¨ useRefï¼Ÿ

1. **æŒä¹…åŒ–**: `useRef` çš„å€¼åœ¨ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ä¿æŒä¸å˜
2. **ä¸è§¦å‘é‡æ¸²æŸ“**: æ›´æ–° `ref.current` ä¸ä¼šå¯¼è‡´ç»„ä»¶é‡æ–°æ¸²æŸ“
3. **å®Œç¾çš„"å‰ä¸€ä¸ªå€¼"å­˜å‚¨**: é€‚åˆè·Ÿè¸ªçŠ¶æ€å˜åŒ–

### ä¸ºä»€ä¹ˆä¸ç”¨ useStateï¼Ÿ

```typescript
// âŒ ä¸æ¨èï¼šä¼šå¯¼è‡´é¢å¤–çš„æ¸²æŸ“
const [prevAddress, setPrevAddress] = useState<string | null>(null);

useEffect(() => {
  if (prevAddress && !address) {
    navigate('/');
  }
  setPrevAddress(address); // è§¦å‘é‡æ–°æ¸²æŸ“
}, [address]);
```

ä½¿ç”¨ `useState` ä¼šåœ¨æ¯æ¬¡ `address` å˜åŒ–æ—¶è§¦å‘ä¸¤æ¬¡æ¸²æŸ“ï¼š
1. `address` å˜åŒ–è§¦å‘æ¸²æŸ“
2. `setPrevAddress` è§¦å‘æ¸²æŸ“

ä½¿ç”¨ `useRef` åªæœ‰ä¸€æ¬¡æ¸²æŸ“ã€‚

## ğŸ”’ å†»ç»“ç‚¹ä¿æŠ¤

âœ… æ‰€æœ‰å†»ç»“ç‚¹ä¿æŒä¸å˜ï¼š
- åªä¿®æ”¹äº†å¯¼èˆªé€»è¾‘çš„è§¦å‘æ¡ä»¶
- ä¸å½±å“ä»»ä½•ä¸šåŠ¡é€»è¾‘
- ä¸å½±å“åˆçº¦è°ƒç”¨
- ä¸å½±å“æ•°æ®æµ

## ğŸ“Š å½±å“åˆ†æ

### æ­£é¢å½±å“
- âœ… ä¿®å¤äº†æ— é™å¾ªç¯é—®é¢˜
- âœ… æ”¹å–„ç”¨æˆ·ä½“éªŒ
- âœ… å‡å°‘ä¸å¿…è¦çš„å¯¼èˆª
- âœ… æ›´ç²¾ç¡®çš„æ–­å¼€æ£€æµ‹

### æ€§èƒ½å½±å“
- âœ… æ— æ€§èƒ½æŸå¤±ï¼ˆuseRef å¼€é”€æå°ï¼‰
- âœ… å‡å°‘äº†ä¸å¿…è¦çš„å¯¼èˆª
- âœ… å‡å°‘äº†æµè§ˆå™¨è­¦å‘Š

## ğŸš€ æµ‹è¯•å»ºè®®

### 1. æ— é™å¾ªç¯æµ‹è¯•
1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
2. è®¿é—® http://localhost:5173
3. **ä¸è¿æ¥é’±åŒ…**
4. å°è¯•è®¿é—® `/tasks`
5. éªŒè¯ï¼šåº”è¯¥æ˜¾ç¤º"è¯·è¿æ¥é’±åŒ…"ï¼Œè€Œä¸æ˜¯æ— é™å¾ªç¯

### 2. æ–­å¼€æµ‹è¯•
1. è¿æ¥é’±åŒ…
2. è®¿é—®ä»»æ„è®¤è¯é¡µé¢
3. åœ¨ MetaMask ä¸­æ–­å¼€é’±åŒ…
4. éªŒè¯ï¼šè‡ªåŠ¨è·³è½¬åˆ°é¦–é¡µ

### 3. åˆ‡æ¢è´¦æˆ·æµ‹è¯•
1. è¿æ¥é’±åŒ…
2. è®¿é—®ä»»æ„è®¤è¯é¡µé¢
3. åœ¨ MetaMask ä¸­åˆ‡æ¢è´¦æˆ·
4. éªŒè¯ï¼šé¡µé¢æ­£å¸¸åˆ·æ–°ï¼Œä¸ä¼šè·³è½¬åˆ°é¦–é¡µ

## âœ… æ€»ç»“

é€šè¿‡ä½¿ç”¨ `useRef` è·Ÿè¸ªå‰ä¸€ä¸ª `address` å€¼ï¼Œæˆ‘ä»¬æˆåŠŸä¿®å¤äº†æ— é™å¯¼èˆªå¾ªç¯é—®é¢˜ï¼ŒåŒæ—¶ä¿æŒäº†é’±åŒ…æ–­å¼€æ—¶è‡ªåŠ¨è¿”å›é¦–é¡µçš„åŠŸèƒ½ã€‚

è¿™æ˜¯ä¸€ä¸ªæ›´ç²¾ç¡®ã€æ›´é«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆï¼Œå®Œå…¨ç¬¦åˆ React æœ€ä½³å®è·µã€‚

---

**ä¿®å¤ç‰ˆæœ¬**: v2
**ä¿®å¤æ—¥æœŸ**: 2024-11-24
**é—®é¢˜ä¸¥é‡æ€§**: é«˜ï¼ˆå¯¼è‡´æ— é™å¾ªç¯ï¼‰
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶éªŒè¯
