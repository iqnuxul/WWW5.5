<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç”¨æˆ·AIçŸ¥è¯†åº“å¹³å° - æœ¬åœ°Ganache</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; background: #f0f2f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header h1 { margin-bottom: 10px; }
        .header-info { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .nav { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav button { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; transition: all 0.3s; }
        .nav button:hover { background: #5568d3; transform: translateY(-2px); }
        .nav button.active { background: #764ba2; }
        .section { background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: none; }
        .section.active { display: block; }
        .section h2 { margin-bottom: 20px; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 14px; transition: border 0.3s; }
        input:focus, textarea:focus { outline: none; border-color: #667eea; }
        textarea { min-height: 150px; resize: vertical; }
        button { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        button:hover { background: #5568d3; transform: translateY(-2px); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-card h3 { font-size: 14px; opacity: 0.9; margin-bottom: 10px; }
        .stat-card p { font-size: 24px; font-weight: bold; }
        .share-item { padding: 15px; border-bottom: 1px solid #eee; transition: background 0.3s; }
        .share-item:hover { background: #f8f9fa; }
        .share-item:last-child { border-bottom: none; }
        .chat-area { height: 400px; overflow-y: auto; border: 2px solid #e0e0e0; padding: 15px; margin: 15px 0; border-radius: 5px; background: #fafafa; }
        .message { margin: 15px 0; padding: 12px 16px; border-radius: 8px; max-width: 80%; word-wrap: break-word; }
        .user-msg { background: #667eea; color: white; margin-left: auto; text-align: right; }
        .ai-msg { background: white; border: 1px solid #e0e0e0; }
        .sources { background: #e3f2fd; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px; }
        .alert { padding: 12px; border-radius: 5px; margin: 10px 0; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        label { display: flex; align-items: center; margin: 10px 0; cursor: pointer; }
        label input[type="checkbox"] { margin-right: 8px; width: auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ å¤šç”¨æˆ·AIçŸ¥è¯†åº“å¹³å° (æœ¬åœ°Ganache)</h1>
            <div class="header-info">
                <p>å½“å‰ç”¨æˆ·: <span id="currentUser">æœªç™»å½•</span></p>
                <p>è¿æ¥é’±åŒ…: <span id="connectedWallet">æœªè¿æ¥</span></p>
                <button onclick="logout()" style="background: rgba(255,255,255,0.2);">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <div class="nav">
            <button onclick="showSection('upload')" class="active">ğŸ“¤ ä¸Šä¼ å¹¶é“¸é€ NFT</button>
            <button onclick="showSection('shares')">ğŸ“‹ å†…å®¹åˆ†äº«</button>
            <button onclick="showSection('chat')">ğŸ’¬ AIå¯¹è¯</button>
            <button onclick="showSection('search')">ğŸ” æœç´¢NFT</button>
            <button onclick="showSection('stats')">ğŸ“Š æˆ‘çš„ç»Ÿè®¡</button>
        </div>

        <!-- ä¸Šä¼ å¹¶é“¸é€ NFT -->
        <div id="upload" class="section active">
            <h2>ğŸ“¤ ä¸Šä¼ æ–‡æœ¬å¹¶é“¸é€ NFT</h2>
            <div class="alert alert-info">
                <strong>æç¤ºï¼š</strong> è¯·å…ˆè¿æ¥MetaMaské’±åŒ…ï¼Œç¡®ä¿é’±åŒ…è¿æ¥åˆ°æœ¬åœ°Ganacheç½‘ç»œã€‚ä¸Šä¼ å†…å®¹å°†è‡ªåŠ¨ä¸Šä¼ åˆ°æœ¬åœ°IPFSå¹¶é“¸é€ NFTã€‚
            </div>
            <textarea id="contentInput" placeholder="è¾“å…¥è¦ä¸Šä¼ çš„æ–‡æœ¬å†…å®¹..."></textarea>
            <label>
                <input type="checkbox" id="authorizeRAG"> æˆæƒç”¨äºRAGç”Ÿæˆï¼ˆæ–‡ä»¶å°†ä¿å­˜åˆ°æœ¬åœ°çŸ¥è¯†åº“ï¼‰
            </label>
            <button onclick="uploadAndMint()" id="mintBtn">ä¸Šä¼ å¹¶é“¸é€ NFT</button>
            <div id="uploadResult"></div>
        </div>

        <!-- å†…å®¹åˆ†äº« -->
        <div id="shares" class="section">
            <h2>ğŸ“‹ å†…å®¹åˆ†äº«</h2>
            <div id="sharesList">åŠ è½½ä¸­...</div>
        </div>

        <!-- AIå¯¹è¯ -->
        <div id="chat" class="section">
            <h2>ğŸ’¬ AIå¯¹è¯ (æ¯æ¬¡ 0.000001 ETH)</h2>
            <div class="alert alert-info">
                <strong>æç¤ºï¼š</strong> æ¯æ¬¡å¯¹è¯éœ€è¦æ”¯ä»˜ 0.000001 ETHã€‚å›ç­”ä¸­ä½¿ç”¨çš„çŸ¥è¯†åº“å†…å®¹å°†è‡ªåŠ¨è®°å½•æ¥æºï¼Œå¹¶åˆ†å‘å¥–åŠ±ç»™å†…å®¹æä¾›è€…ã€‚
            </div>
            <div class="chat-area" id="chatArea">
                <div class="message ai-msg">æ¬¢è¿ä½¿ç”¨AIçŸ¥è¯†åº“ï¼è¯·å¼€å§‹æé—®ã€‚</div>
            </div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="questionInput" placeholder="è¾“å…¥é—®é¢˜..." onkeypress="if(event.key==='Enter') askAI()">
                <button onclick="askAI()" id="askBtn">å‘é€ (éœ€è¦æ”¯ä»˜)</button>
            </div>
        </div>

        <!-- æœç´¢NFT -->
        <div id="search" class="section">
            <h2>ğŸ” æœç´¢NFT</h2>
            <div style="display: flex; gap: 10px;">
                <input type="number" id="nftIdInput" placeholder="è¾“å…¥NFT ID">
                <button onclick="searchNFT()">æœç´¢</button>
            </div>
            <div id="searchResult" style="margin-top: 20px;"></div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div id="stats" class="section">
            <h2>ğŸ“Š æˆ‘çš„ç»Ÿè®¡</h2>
            <div class="stats">
                <div class="stat-card">
                    <h3>æ€»æ”¶ç›Š</h3>
                    <p id="totalEarnings">0 ETH</p>
                </div>
                <div class="stat-card">
                    <h3>å¼•ç”¨é‡</h3>
                    <p id="citationCount">0</p>
                </div>
                <div class="stat-card">
                    <h3>æ€»æ”¯å‡º</h3>
                    <p id="totalSpent">0 ETH</p>
                </div>
                <div class="stat-card">
                    <h3>å¯¹è¯æ¬¡æ•°</h3>
                    <p id="chatCount">0</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let provider, signer, nftContract, rewardContract;
let contractAddresses = {};
const CHAT_FEE = '0.000001'; // ETH

// å®Œæ•´çš„åˆçº¦ABIå®šä¹‰ï¼ˆç¡®ä¿ä¸åç«¯ä¸€è‡´ï¼‰
const NFT_ABI = [
    {
        "inputs": [{"internalType": "address", "name": "to", "type": "address"},
                  {"internalType": "string", "name": "uri", "type": "string"}],
        "name": "mint",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
        "name": "tokenURI",
        "outputs": [{"internalType": "string", "name": "", "type": "string"}],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
        "name": "ownerOf",
        "outputs": [{"internalType": "address", "name": "", "type": "address"}],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "anonymous": false,
        "inputs": [
            {"indexed": true, "internalType": "address", "name": "from", "type": "address"},
            {"indexed": true, "internalType": "address", "name": "to", "type": "address"},
            {"indexed": true, "internalType": "uint256", "name": "tokenId", "type": "uint256"}
        ],
        "name": "Transfer",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {"indexed": true, "internalType": "address", "name": "to", "type": "address"},
            {"indexed": true, "internalType": "uint256", "name": "tokenId", "type": "uint256"},
            {"indexed": false, "internalType": "string", "name": "uri", "type": "string"}
        ],
        "name": "Mint",
        "type": "event"
    }
];

const REWARD_ABI = [
    {
        "inputs": [{"internalType": "bytes32", "name": "conversationId", "type": "bytes32"}],
        "name": "payForChat",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "chatFee",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    }
];

// åˆå§‹åŒ–
async function init() {
    console.log('å¼€å§‹åˆå§‹åŒ–...');
    
    // è·å–åˆçº¦ä¿¡æ¯
    try {
        const response = await fetch('/api/contract_info');
        contractAddresses = await response.json();
        console.log('è·å–åˆçº¦ä¿¡æ¯æˆåŠŸ:', contractAddresses);
    } catch (error) {
        console.error('è·å–åˆçº¦ä¿¡æ¯å¤±è´¥:', error);
        showAlert('uploadResult', 'è·å–åˆçº¦ä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡', 'error');
    }

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    await checkLoginStatus();
    
    // åˆå§‹åŒ–Web3ï¼ˆè¿æ¥åˆ°Ganacheï¼‰
    await initWeb3();
}

async function checkLoginStatus() {
    try {
        const response = await fetch('/api/stats');
        if (response.ok) {
            document.getElementById('currentUser').textContent = 'å·²ç™»å½•';
            console.log('ç”¨æˆ·å·²ç™»å½•');
        } else {
            window.location.href = '/';
        }
    } catch (error) {
        window.location.href = '/';
    }
}

async function initWeb3() {
    console.log('å¼€å§‹åˆå§‹åŒ–Web3...');
    
    try {
        if (typeof window.ethereum !== 'undefined') {
            console.log('æ£€æµ‹åˆ°MetaMask');
            provider = new ethers.providers.Web3Provider(window.ethereum);
            
            // è¯·æ±‚è´¦æˆ·è®¿é—®
            console.log('è¯·æ±‚è´¦æˆ·è®¿é—®...');
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            
            // æ£€æŸ¥ç½‘ç»œ
            const network = await provider.getNetwork();
            console.log('å½“å‰ç½‘ç»œ:', network);
            
            // å¦‚æœæ˜¯Ganacheç½‘ç»œï¼ˆchainId: 1337ï¼‰
            if (network.chainId !== 1337) {
                console.log('ç½‘ç»œä¸åŒ¹é…ï¼Œå°è¯•åˆ‡æ¢åˆ°Ganache...');
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x539' }] // 1337 in hex
                    });
                    console.log('ç½‘ç»œåˆ‡æ¢æˆåŠŸ');
                } catch (switchError) {
                    // å¦‚æœç½‘ç»œä¸å­˜åœ¨ï¼Œæ·»åŠ å®ƒ
                    if (switchError.code === 4902) {
                        console.log('ç½‘ç»œä¸å­˜åœ¨ï¼Œæ·»åŠ Ganacheç½‘ç»œ...');
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x539',
                                chainName: 'Ganache Local',
                                rpcUrls: ['http://127.0.0.1:7545'],
                                nativeCurrency: {
                                    name: 'ETH',
                                    symbol: 'ETH',
                                    decimals: 18
                                }
                            }]
                        });
                        console.log('ç½‘ç»œæ·»åŠ æˆåŠŸ');
                    } else {
                        throw switchError;
                    }
                }
            }
            
            signer = provider.getSigner();
            const address = await signer.getAddress();
            console.log('å½“å‰é’±åŒ…åœ°å€:', address);
            document.getElementById('connectedWallet').textContent = address.substring(0, 6) + '...' + address.substring(38);
            
            // åŠ è½½åˆçº¦
            await loadContracts();
        } else {
            console.log('æœªæ£€æµ‹åˆ°MetaMaskï¼Œä½¿ç”¨ç›´æ¥è¿æ¥');
            provider = new ethers.providers.JsonRpcProvider('http://127.0.0.1:7545');
            alert('è¯·å®‰è£…MetaMaskå¹¶è¿æ¥åˆ°æœ¬åœ°Ganacheç½‘ç»œ');
        }
    } catch (error) {
        console.error('åˆå§‹åŒ–Web3å¤±è´¥:', error);
        showAlert('uploadResult', 'Web3åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
    }
}

async function loadContracts() {
    console.log('å¼€å§‹åŠ è½½åˆçº¦...');
    console.log('åˆçº¦åœ°å€ä¿¡æ¯:', contractAddresses);
    
    try {
        if (contractAddresses.nft_contract_address && contractAddresses.nft_contract_address !== '0x...') {
            console.log('æ­£åœ¨åŠ è½½NFTåˆçº¦:', contractAddresses.nft_contract_address);
            nftContract = new ethers.Contract(contractAddresses.nft_contract_address, NFT_ABI, signer);
            
            // æµ‹è¯•åˆçº¦è¿æ¥
            try {
                const name = await nftContract.name();
                console.log('NFTåˆçº¦è¿æ¥æˆåŠŸï¼Œåç§°:', name);
            } catch (testError) {
                console.log('NFTåˆçº¦æµ‹è¯•è°ƒç”¨å¤±è´¥ï¼Œä½†ç»§ç»­åŠ è½½:', testError);
            }
            
            console.log('NFTåˆçº¦åŠ è½½æˆåŠŸ');
        } else {
            console.error('NFTåˆçº¦åœ°å€æ— æ•ˆ:', contractAddresses.nft_contract_address);
            showAlert('uploadResult', 'NFTåˆçº¦åœ°å€é…ç½®æ— æ•ˆ', 'error');
        }
        
        if (contractAddresses.reward_contract_address && contractAddresses.reward_contract_address !== '0x...') {
            console.log('æ­£åœ¨åŠ è½½å¥–åŠ±åˆçº¦:', contractAddresses.reward_contract_address);
            rewardContract = new ethers.Contract(contractAddresses.reward_contract_address, REWARD_ABI, signer);
            
            // æµ‹è¯•åˆçº¦è¿æ¥
            try {
                const fee = await rewardContract.chatFee();
                console.log('å¥–åŠ±åˆçº¦è¿æ¥æˆåŠŸï¼Œè´¹ç”¨:', fee.toString());
            } catch (testError) {
                console.log('å¥–åŠ±åˆçº¦æµ‹è¯•è°ƒç”¨å¤±è´¥ï¼Œä½†ç»§ç»­åŠ è½½:', testError);
            }
            
            console.log('å¥–åŠ±åˆçº¦åŠ è½½æˆåŠŸ');
        } else {
            console.error('å¥–åŠ±åˆçº¦åœ°å€æ— æ•ˆ:', contractAddresses.reward_contract_address);
            showAlert('uploadResult', 'å¥–åŠ±åˆçº¦åœ°å€é…ç½®æ— æ•ˆ', 'error');
        }
        
        // æ£€æŸ¥åˆçº¦æ˜¯å¦æˆåŠŸåŠ è½½
        if (nftContract && rewardContract) {
            console.log('æ‰€æœ‰åˆçº¦åŠ è½½æˆåŠŸï¼');
            showAlert('uploadResult', 'åˆçº¦åŠ è½½æˆåŠŸï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨', 'success');
        }
        
    } catch (error) {
        console.error('åŠ è½½åˆçº¦å¤±è´¥:', error);
        showAlert('uploadResult', 'åŠ è½½åˆçº¦å¤±è´¥: ' + error.message, 'error');
    }
}

async function uploadAndMint() {
    const content = document.getElementById('contentInput').value;
    const authorizeRAG = document.getElementById('authorizeRAG').checked;

    if (!content.trim()) {
        showAlert('uploadResult', 'è¯·è¾“å…¥å†…å®¹', 'error');
        return;
    }

    if (!nftContract) {
        showAlert('uploadResult', 'NFTåˆçº¦æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥åˆçº¦åœ°å€é…ç½®', 'error');
        console.log('å½“å‰nftContract:', nftContract);
        console.log('åˆçº¦åœ°å€:', contractAddresses.nft_contract_address);
        return;
    }

    const btn = document.getElementById('mintBtn');
    btn.disabled = true;
    btn.textContent = 'å¤„ç†ä¸­...';

    try {
        // 1. å…ˆä¸Šä¼ åˆ°IPFSï¼ˆé€šè¿‡åç«¯ï¼‰
        showAlert('uploadResult', 'æ­£åœ¨ä¸Šä¼ åˆ°æœ¬åœ°IPFS...', 'info');
        
        // 2. å‡†å¤‡IPFS URIï¼ˆè¿™é‡Œç®€åŒ–ï¼Œå®é™…åº”è¯¥å…ˆä¸Šä¼ è·å–hashï¼‰
        const ipfsHash = 'temp_' + Date.now(); // ä¸´æ—¶å€¼ï¼Œå®é™…åº”è¯¥ä»åç«¯è·å–
        const tokenURI = `ipfs://${ipfsHash}`;

        // 3. é“¸é€ NFT
        showAlert('uploadResult', 'æ­£åœ¨é“¸é€ NFT...', 'info');
        console.log('å¼€å§‹é“¸é€ NFT...');
        const mintTx = await nftContract.mint(await signer.getAddress(), tokenURI);
        console.log('é“¸é€ äº¤æ˜“å·²å‘é€:', mintTx.hash);
        showAlert('uploadResult', `äº¤æ˜“å·²å‘é€: ${mintTx.hash}ï¼Œç­‰å¾…ç¡®è®¤...`, 'info');
        
        const receipt = await mintTx.wait();
        console.log('äº¤æ˜“ç¡®è®¤:', receipt);
        
        // 4. ä»äº‹ä»¶ä¸­è·å–tokenId
        let nftId = '1'; // é»˜è®¤å€¼
        if (receipt.events && receipt.events.length > 0) {
            const mintEvent = receipt.events.find(e => e.event === 'Mint');
            if (mintEvent) {
                nftId = mintEvent.args.tokenId.toString();
            } else {
                // å¦‚æœæ²¡æœ‰Mintäº‹ä»¶ï¼Œå°è¯•ä»Transferäº‹ä»¶è·å–
                const transferEvent = receipt.events.find(e => e.event === 'Transfer' && e.args.from === '0x0000000000000000000000000000000000000000');
                if (transferEvent) {
                    nftId = transferEvent.args.tokenId.toString();
                }
            }
        }
        
        console.log('NFTé“¸é€ æˆåŠŸï¼ŒID:', nftId);
        showAlert('uploadResult', `NFTé“¸é€ æˆåŠŸï¼ID: ${nftId}`, 'success');

        // 5. ä¸Šä¼ å†…å®¹åˆ°åç«¯å¹¶ä¿å­˜
        const response = await fetch('/api/upload_and_mint', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                content,
                authorize_rag: authorizeRAG,
                mint_tx_hash: receipt.transactionHash,
                nft_id: nftId
            })
        });

        const result = await response.json();
        if (result.success) {
            showAlert('uploadResult', 
                `âœ… å®Œæˆï¼NFT ID: ${result.nft_id}<br>IPFS: <a href="${result.ipfs_link}" target="_blank">${result.ipfs_link}</a>`, 
                'success');
            document.getElementById('contentInput').value = '';
        } else {
            showAlert('uploadResult', 'é”™è¯¯: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('é“¸é€ NFTé”™è¯¯:', error);
        showAlert('uploadResult', 'é”™è¯¯: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'ä¸Šä¼ å¹¶é“¸é€ NFT';
    }
}

// å…¶ä»–å‡½æ•°ä¿æŒä¸å˜...

        async function loadShares() {
            try {
                const response = await fetch('/api/shares');
                const shares = await response.json();
                const list = document.getElementById('sharesList');
                
                if (shares.length === 0) {
                    list.innerHTML = '<p>æš‚æ— åˆ†äº«å†…å®¹</p>';
                    return;
                }
                
                list.innerHTML = shares.map(s => `
                    <div class="share-item">
                        <strong>${s.user_name}</strong> åœ¨ ${new Date(s.created_at).toLocaleString()} åˆ†äº«äº† 
                        <strong>NFT #${s.nft_id}</strong><br>
                        <a href="${s.ipfs_link}" target="_blank">ğŸ”— IPFSé“¾æ¥</a>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('sharesList').innerHTML = '<p>åŠ è½½å¤±è´¥: ' + error.message + '</p>';
            }
        }

        async function askAI() {
            const question = document.getElementById('questionInput').value.trim();
            if (!question) return;

            if (!rewardContract) {
                alert('å¥–åŠ±åˆçº¦æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥åˆçº¦åœ°å€é…ç½®');
                return;
            }

            const btn = document.getElementById('askBtn');
            btn.disabled = true;

            try {
                // 1. æ”¯ä»˜å¯¹è¯è´¹ç”¨
                const conversationId = ethers.utils.id(question + Date.now().toString());
                const chatFeeWei = await rewardContract.chatFee();
                
                const payTx = await rewardContract.payForChat(conversationId, {
                    value: chatFeeWei
                });
                
                showMessage('user-msg', `æ”¯ä»˜äº¤æ˜“: ${payTx.hash}ï¼Œç­‰å¾…ç¡®è®¤...`);
                
                await payTx.wait();
                showMessage('user-msg', question);
                
                // 2. å‘é€é—®é¢˜åˆ°åç«¯
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        question,
                        payment_tx_hash: payTx.hash,
                        conversation_id: conversationId
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let aiMessageDiv = null;

                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, {stream: true});
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[END]') break;
                            
                            if (!aiMessageDiv) {
                                aiMessageDiv = document.createElement('div');
                                aiMessageDiv.className = 'message ai-msg';
                                document.getElementById('chatArea').appendChild(aiMessageDiv);
                            }
                            
                            aiMessageDiv.textContent += data;
                            document.getElementById('chatArea').scrollTop = document.getElementById('chatArea').scrollHeight;
                        }
                    }
                }
            } catch (error) {
                console.error('é”™è¯¯:', error);
                showMessage('ai-msg', 'é”™è¯¯: ' + error.message);
            } finally {
                btn.disabled = false;
                document.getElementById('questionInput').value = '';
            }
        }

        function showMessage(type, content) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = content;
            document.getElementById('chatArea').appendChild(div);
            document.getElementById('chatArea').scrollTop = document.getElementById('chatArea').scrollHeight;
        }

        async function searchNFT() {
            const nftId = document.getElementById('nftIdInput').value;
            if (!nftId) return;

            try {
                const response = await fetch(`/api/search_nft?nft_id=${nftId}`);
                const result = await response.json();

                if (result.error) {
                    document.getElementById('searchResult').innerHTML = 
                        `<div class="alert alert-error">${result.error}</div>`;
                } else {
                    document.getElementById('searchResult').innerHTML = `
                        <div class="alert alert-success">
                            <h3>NFT #${result.nft_id}</h3>
                            <p><strong>ä½œè€…:</strong> ${result.author || result.owner || 'æœªçŸ¥'}</p>
                            <p><strong>å†…å®¹:</strong> ${result.content ? result.content.substring(0, 200) + '...' : 'æ— '}</p>
                            <p><strong>IPFSé“¾æ¥:</strong> <a href="${result.ipfs_link || result.token_uri}" target="_blank">${result.ipfs_link || result.token_uri}</a></p>
                            <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${result.created_at || 'é“¾ä¸Šæ•°æ®'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('searchResult').innerHTML = 
                    `<div class="alert alert-error">æœç´¢å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                document.getElementById('totalEarnings').textContent = stats.total_earnings_eth.toFixed(8) + ' ETH';
                document.getElementById('citationCount').textContent = stats.citation_count;
                document.getElementById('totalSpent').textContent = stats.total_spent_eth.toFixed(8) + ' ETH';
                document.getElementById('chatCount').textContent = stats.chat_count;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
            
            if (sectionId === 'shares') loadShares();
            if (sectionId === 'stats') loadStats();
        }

        function showAlert(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        async function logout() {
            await fetch('/api/logout', {method: 'POST'});
            window.location.href = '/';
        }

        // é¡µé¢åŠ è½½
        window.onload = init;
    </script>
</body>
</html>